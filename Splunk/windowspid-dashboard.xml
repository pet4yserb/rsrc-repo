<form version="1.1" theme="dark">
  <label>Process Investigator</label>
  <fieldset submitButton="true">
    <input type="time" token="timesel">
      <label></label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="text" token="host" searchWhenChanged="true">
      <label>host</label>
      <default>*</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>Sysmon Process Tree</title>
      <input type="text" token="ppn" searchWhenChanged="true">
        <label>Process Name or ProcessID</label>
        <default>*</default>
      </input>
      <input type="text" token="user" searchWhenChanged="true">
        <label>User</label>
        <default>*</default>
      </input>
      <input type="checkbox" token="noise" searchWhenChanged="true">
        <label>Filter Noisy Global Processes</label>
        <choice value="ParentPath!=*vmtoolsd.exe* ParentPath!=*CollectGuestLogs.exe*">Filter</choice>
        <choice value="*">No</choice>
        <default>*</default>
      </input>
      <table>
        <title>$host$ $user$</title>
        <search>
          <query>index=sysmon EventCode=8 OR EventCode=1 OR EventCode=10 host=$host$ 
					| eval ParentPath=coalesce(ParentImage, SourceImage), ChildPath=coalesce(Image, TargetImage), ParentID=coalesce(ParentProcessId, SourceProcessId), ChildID=coalesce(ProcessId,TargetProcessId), ParentUser=coalesce(ParentUser, SourceUser), ChildUser=coalesce(User,TargetUser) 
					| search $noise$ (ParentUser=$user$)
					| fields *
					| fillnull value=" " CommandLine
					| eval parent = ParentPath." (".ParentID.")"
					| eval child = ChildPath." (".ChildID.")"
					| eval detail=strftime(_time,"%Y-%m-%d %H:%M:%S")." ".CommandLine
					| pstree child=child parent=parent detail=detail
					| search tree=*$ppn$*
					| table tree </query>
          <earliest>$timesel.earliest$</earliest>
          <latest>$timesel.latest$</latest>
        </search>
        <option name="count">2</option>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>DNS Query</title>
      <input type="text" token="ppid" searchWhenChanged="true">
        <label>Process ID</label>
        <default>*</default>
      </input>
      <input type="text" token="query" searchWhenChanged="true">
        <label>Query</label>
        <default>*</default>
      </input>
      <table>
        <search>
          <query>index=sysmon EventCode=22 QueryName=$query$ ProcessId=$ppid$ 
					| table QueryName process_name Image User host ProcessId answer record_type </query>
          <earliest>$timesel.earliest$</earliest>
          <latest>$timesel.latest$</latest>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>Windows PID</title>
      <input type="text" token="wpid" searchWhenChanged="true">
        <label>Windows PID / Process Name</label>
        <default>*</default>
      </input>
      <input type="text" token="user2" searchWhenChanged="true">
        <label>User</label>
        <default>*</default>
      </input>
      <input type="checkbox" token="noise2" searchWhenChanged="true">
        <label>Filter Noisy Global Processes</label>
        <choice value="ParentPath!=*vmtoolsd.exe* ParentPath!=*CollectGuestLogs.exe*">Filter</choice>
        <choice value="*">No</choice>
        <default>*</default>
      </input>
      <table>
        <search>
          <query>(index=sysmon source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=1) OR (index=windows EventCode=4688) host=$host$ 
					| eval ParentProcessID=tonumber(coalesce(parent_process_id, Creator_Process_ID), 16)
					| eval ChildProcessID=tonumber(coalesce(process_id, New_Process_ID), 16)

					| eval ParentUser=coalesce(Account_Name, Creator_Subject), ChildUser=coalesce(Account_Name,Target_Subject), ProcessFull=coalesce(process, Process_Command_Line), ParentProcessName=coalesce(parent_process_name, Creator_Process_Name), ChildProcessName=coalesce(process_name, New_Process_Name)

					| search $noise2$ (ParentUser=$user2$ OR ChildUser=$user2)
					| fields *
					| fillnull value=" " ProcessFull ChildUser Parent User ChildProcessID ParentProcessID ParentProcessName ChildProcessName
					| eval parent = ParentProcessID." (".ParentProcessName.")"
					| eval child = ChildProcessID." (".ChildProcessName.")"
					| eval detail=strftime(_time,"%Y-%m-%d %H:%M:%S")." ".ProcessFull
					| pstree child=child parent=parent detail=detail
					| search tree=*$wpid$*
					| table tree 
					| sort tree </query>
          <earliest>$timesel.earliest$</earliest>
          <latest>$timesel.latest$</latest>
        </search>
        <option name="drilldown">cell</option>
        <option name="refresh.display">progressbar</option>
      </table>
    </panel>
  </row>
</form>